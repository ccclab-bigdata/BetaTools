%plot(wavefilter(double(NS5.Data(1,1:100000)),5))
%
samples = 5e5;
channels = 6:9;
combinedSpikePhases = [];
for i=1:length(channels)
    spikeVector = [];
    allBeta = [];
    allSpikes = [];

    disp(strcat('channel:',num2str(channels(i))));
    data = double(NS5.Data(channels(i),:));
    HPdata = wavefilter(data,5);
    locs = absPeakDetection(HPdata);
    allSpikes{i} = locs*(3e4^-1);
    spikeVector = horzcat(spikeVector,allSpikes{i});
    
    [t,f,Snorm]=betaspec(data);
    cSnorm = normalize(mean(Snorm)); %normalized(0-1)-compressed Snorm
    allBeta(i,:) = cSnorm(1,:);

    meanBeta = mean(allBeta,1);

    xend = samples/3e4;
    figure;

    % subplot(4,1,1);
    % plotSpikeRaster(allSpikes');
    % xlim([0 xend]);
    % title('All Spikes Raster');
    % ylabel('channel');

    subplot(3,1,1);
    hist(spikeVector,300);
    xlim([0 xend]);
    title('All Spikes Histogram (300 bins)');
    ylabel('spike count');

    subplot(3,1,2);
    plot(t,meanBeta);
    xlim([0 xend]);
    title('Beta Power (13-30Hz)');
    ylabel('normalized power');

    subplot(3,1,3);
    imagesc(t,f,Snorm);
    xlim([0 xend]);
    title('Beta Spectrogram (13-30Hz)');
    ylabel('frequency');

    xlabel(strcat('time (s)--','channel:',num2str(channels(i))));

    thresh = mean(meanBeta) + std(meanBeta);
    threshCrossTimes = getThreshCrossTimes(meanBeta,thresh);

    % % figure;
    % % plot(meanBeta);
    % % hold on;
    % % for i=1:length(threshCrossTimes)
    % %     plot(threshCrossTimes{i},meanBeta(threshCrossTimes{i}),'r');
    % % end
    % % hold off;

    [b,a]=butter(4,2*30*2/3e4,'low'); %how to do bandpass of 13-30?
    spikePhases = [];
    for j=1:length(threshCrossTimes)
        t1 = t(threshCrossTimes{j}(1));
        t2 = t(threshCrossTimes{j}(end));
        if(t1==t2),continue,end;
        trialData = extractdatac(data,3e4,[t1 t2]);
        range = 0:3e4^-1:(3e4^-1)*(length(trialData)-1);
        trialDataLP = filtfilt(b,a,trialData);
        %figure;
        %could do FFT, look for peaks, dont know how to align though
        f = fit(range',trialDataLP,'sin2');
        %plot(f,range',trialDataLP);
        if(f.b1/(2*pi) > 13 && f.b1/(2*pi) < 30)
            amplitude = f.a1;
            frequency = f.b1; %/(2*pi)
            phase = f.c1; %rad2deg()
        elseif(f.b2/(2*pi) > 13 && f.b2/(2*pi) < 30)
            amplitude = f.a2;
            frequency = f.b2;
            phase = f.c2;
        else
            disp('no beta sine found!');
            continue; %handle better
        end

        spikes = extractdatapt(spikeVector,[t1 t2],1); %(x,x,1) zeros them to this trial
        %hold on;plot(spikeTimes.times,zeros(1,length(spikeTimes.times)),'o');
        f = frequency/(2*pi);

        for k=1:length(spikes.times)
            adjTime = mod(spikes.times(k),1/f);
            spikePhase = 360*f*(adjTime+(phase/frequency));
            if(spikePhase < 0)
                spikePhase = 360+spikePhase;
            end
            spikePhases = horzcat(spikePhases,spikePhase);
        end
    end
    figure;
    rose(deg2rad(spikePhases(:)));
    title(strcat('channel:',num2str(channels(i))));
    combinedSpikePhases = horzcat(SpikePhases(:));
end

